{% extends "layout.html" %}

{% block title %}Vendor Analysis{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 2rem;
    }
    
    .vendor-card {
        transition: transform 0.3s ease;
        border-radius: 8px;
        overflow: hidden;
        height: 100%;
    }
    
    .vendor-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
    }
    
    .vendor-stat {
        padding: 1.5rem;
        text-align: center;
        height: 100%;
    }
    
    .vendor-count {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .stat-critical { color: #dc3545; }
    .stat-high { color: #fd7e14; }
    .stat-medium { color: #ffc107; }
    .stat-low { color: #0dcaf0; }
    
    .progress-stacked {
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
    }
    
    .vendor-table th, .vendor-table td {
        vertical-align: middle;
    }
    
    .vendor-badge {
        display: inline-block;
        min-width: 24px;
        padding: 3px 6px;
        text-align: center;
        font-size: 0.75rem;
        font-weight: normal;
        border-radius: 4px;
        margin-left: 6px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <nav aria-label="breadcrumb" class="mt-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
            <li class="breadcrumb-item active">Vendor Analysis</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0"><i class="bi bi-building text-primary me-2"></i>Vendor Analysis</h1>
        <span class="badge bg-primary p-2 fs-6">{{ vendor_count }} Vendors Analyzed</span>
    </div>
    
    <!-- Vendor Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card vendor-card bg-light">
                <div class="vendor-stat">
                    <div class="vendor-count">{{ vendor_count }}</div>
                    <div class="text-muted">Vendors with CVEs</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card vendor-card bg-light">
                <div class="vendor-stat">
                    <div class="vendor-count stat-critical">{{ vendors_with_critical }}</div>
                    <div class="text-muted">Vendors with Critical CVEs</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card vendor-card bg-light">
                <div class="vendor-stat">
                    <div class="vendor-count stat-high">{{ vendors_with_high }}</div>
                    <div class="text-muted">Vendors with High CVEs</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card vendor-card bg-light">
                <div class="vendor-stat">
                    <div class="vendor-count">{{ top_vendors[0].cve_count if top_vendors else 0 }}</div>
                    <div class="text-muted">CVEs in Top Vendor</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vendor Analysis Charts -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0">Top Vendors by CVE Count</h2>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="topVendorsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-danger text-white">
                    <h2 class="h5 mb-0">Most Critical Vendors</h2>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="criticalVendorsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Severity Distribution -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h2 class="h5 mb-0">Vulnerability Severity Distribution</h2>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <div class="chart-container">
                        <canvas id="severityDistributionChart"></canvas>
                    </div>
                </div>
                <div class="col-md-4">
                    <h6 class="text-muted mb-3">Severity Breakdown</h6>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span><span class="severity-badge bg-danger"></span> Critical</span>
                            <span>{{ total_critical }}</span>
                        </div>
                        <div class="progress mb-3">
                            <div class="progress-bar bg-danger" style="width: {{ (total_critical / (total_critical + total_high + total_medium + total_low + total_unknown)) * 100 }}%"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span><span class="severity-badge bg-warning"></span> High</span>
                            <span>{{ total_high }}</span>
                        </div>
                        <div class="progress mb-3">
                            <div class="progress-bar bg-warning" style="width: {{ (total_high / (total_critical + total_high + total_medium + total_low + total_unknown)) * 100 }}%"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span><span class="severity-badge bg-info"></span> Medium</span>
                            <span>{{ total_medium }}</span>
                        </div>
                        <div class="progress mb-3">
                            <div class="progress-bar bg-info" style="width: {{ (total_medium / (total_critical + total_high + total_medium + total_low + total_unknown)) * 100 }}%"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span><span class="severity-badge bg-success"></span> Low</span>
                            <span>{{ total_low }}</span>
                        </div>
                        <div class="progress mb-3">
                            <div class="progress-bar bg-success" style="width: {{ (total_low / (total_critical + total_high + total_medium + total_low + total_unknown)) * 100 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Vendors Table -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h2 class="h5 mb-0">Top 10 Vendors by CVE Count</h2>
            <a href="{{ url_for('top_vendors') }}" class="btn btn-sm btn-primary">
                <i class="bi bi-eye me-1"></i>View All Vendors
            </a>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover vendor-table">
                    <thead class="table-light">
                        <tr>
                            <th>Vendor</th>
                            <th>Total CVEs</th>
                            <th>Critical</th>
                            <th>High</th>
                            <th>Medium & Low</th>
                            <th>Severity Distribution</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for vendor in top_vendors %}
                        <tr>
                            <td>{{ vendor.name }}</td>
                            <td><strong>{{ vendor.cve_count }}</strong></td>
                            <td>
                                <span class="badge bg-danger">{{ vendor.critical }}</span>
                            </td>
                            <td>
                                <span class="badge bg-warning text-dark">{{ vendor.high }}</span>
                            </td>
                            <td>
                                <span class="badge bg-info text-dark">{{ vendor.medium + vendor.low }}</span>
                            </td>
                            <td>
                                <div class="progress-stacked">
                                    <div class="progress-bar bg-danger" role="progressbar" style="width: {{ (vendor.critical / vendor.cve_count) * 100 if vendor.cve_count > 0 else 0 }}%"></div>
                                    <div class="progress-bar bg-warning" role="progressbar" style="width: {{ (vendor.high / vendor.cve_count) * 100 if vendor.cve_count > 0 else 0 }}%"></div>
                                    <div class="progress-bar bg-info" role="progressbar" style="width: {{ (vendor.medium / vendor.cve_count) * 100 if vendor.cve_count > 0 else 0 }}%"></div>
                                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ (vendor.low / vendor.cve_count) * 100 if vendor.cve_count > 0 else 0 }}%"></div>
                                </div>
                            </td>
                            <td>
                                <a href="{{ url_for('vendor_detail', vendor=vendor.slug) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-eye me-1"></i>Details
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chart colors
    const colors = {
        primary: '#0d6efd',
        danger: '#dc3545',
        warning: '#fd7e14',
        info: '#0dcaf0',
        success: '#20c997',
        secondary: '#6c757d'
    };
    
    // Top Vendors by CVE Count chart
    const topVendorsCtx = document.getElementById('topVendorsChart').getContext('2d');
    new Chart(topVendorsCtx, {
        type: 'bar',
        data: {
            labels: {{ vendor_names|tojson }},
            datasets: [{
                label: 'CVE Count',
                data: {{ vendor_cve_counts|tojson }},
                backgroundColor: colors.primary,
                borderColor: colors.primary,
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of CVEs'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    // Most Critical Vendors chart
    const criticalVendorsCtx = document.getElementById('criticalVendorsChart').getContext('2d');
    new Chart(criticalVendorsCtx, {
        type: 'bar',
        data: {
            labels: {{ critical_vendor_names|tojson }},
            datasets: [{
                label: 'Critical CVEs',
                data: {{ critical_vendor_counts|tojson }},
                backgroundColor: colors.danger,
                borderColor: colors.danger,
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Critical CVEs'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    // Severity Distribution chart
    const severityDistributionCtx = document.getElementById('severityDistributionChart').getContext('2d');
    new Chart(severityDistributionCtx, {
        type: 'pie',
        data: {
            labels: ['Critical', 'High', 'Medium', 'Low', 'Unknown'],
            datasets: [{
                data: [
                    {{ total_critical }},
                    {{ total_high }},
                    {{ total_medium }},
                    {{ total_low }},
                    {{ total_unknown }}
                ],
                backgroundColor: [
                    colors.danger,
                    colors.warning,
                    colors.info,
                    colors.success,
                    colors.secondary
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
});
</script>
{% endblock %}