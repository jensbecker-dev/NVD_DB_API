{% extends "layout.html" %}

{% block title %}Vendor Analysis - NVD CVE Database Explorer{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 2rem;
    }
    
    .vendor-card {
        transition: transform 0.3s ease;
        border-radius: 8px;
        overflow: hidden;
        height: 100%;
    }
    
    .vendor-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
    }
    
    .vendor-stat {
        padding: 1.5rem;
        text-align: center;
        height: 100%;
    }
    
    .vendor-count {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .stat-critical { color: #dc3545; }
    .stat-high { color: #fd7e14; }
    .stat-medium { color: #ffc107; }
    .stat-low { color: #0dcaf0; }
    
    .progress-stacked {
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
    }
    
    .vendor-table th, .vendor-table td {
        vertical-align: middle;
    }
    
    .vendor-badge {
        display: inline-block;
        min-width: 24px;
        padding: 3px 6px;
        text-align: center;
        font-size: 0.75rem;
        font-weight: normal;
        border-radius: 4px;
        margin-left: 6px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4"><i class="bi bi-building me-2"></i>Vendor Analysis</h1>
    <p class="text-muted mb-4">Showing vendors with the highest CVE counts based on associated CPEs (Top {{ vendors|length }} shown).</p>

    {% if vendors %}
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Rank</th>
                                <th>Vendor</th>
                                <th>CVE Count</th>
                            </tr>
                        </thead>
                        <tbody>
                            {# The view function already sorts the vendors #}
                            {% for vendor, count in vendors.items() %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ vendor }}</td>
                                    <td>{{ count }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% else %}
        <div class="alert alert-warning" role="alert">
            No vendor analysis data available. The database might be empty, CPE data might be missing, or the query failed.
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chart colors
    const colors = {
        primary: '#0d6efd',
        danger: '#dc3545',
        warning: '#fd7e14',
        info: '#0dcaf0',
        success: '#20c997',
        secondary: '#6c757d'
    };
    
    // Top Vendors by CVE Count chart
    const topVendorsCtx = document.getElementById('topVendorsChart').getContext('2d');
    new Chart(topVendorsCtx, {
        type: 'bar',
        data: {
            labels: {{ vendor_names|default([])|tojson }}, // Added default
            datasets: [{
                label: 'CVE Count',
                data: {{ vendor_cve_counts|default([])|tojson }}, // Added default
                backgroundColor: colors.primary,
                borderColor: colors.primary,
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of CVEs'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    // Most Critical Vendors chart
    const criticalVendorsCtx = document.getElementById('criticalVendorsChart').getContext('2d');
    new Chart(criticalVendorsCtx, {
        type: 'bar',
        data: {
            labels: {{ critical_vendor_names|default([])|tojson }}, // Added default
            datasets: [{
                label: 'Critical CVEs',
                data: {{ critical_vendor_counts|default([])|tojson }}, // Added default
                backgroundColor: colors.danger,
                borderColor: colors.danger,
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Critical CVEs'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    // Severity Distribution chart
    const severityDistributionCtx = document.getElementById('severityDistributionChart').getContext('2d');
    new Chart(severityDistributionCtx, {
        type: 'pie',
        data: {
            labels: ['Critical', 'High', 'Medium', 'Low', 'Unknown'],
            datasets: [{
                data: [
                    {{ total_critical|default(0) }}, // Added default
                    {{ total_high|default(0) }}, // Added default
                    {{ total_medium|default(0) }}, // Added default
                    {{ total_low|default(0) }}, // Added default
                    {{ total_unknown|default(0) }} // Added default
                ],
                backgroundColor: [
                    colors.danger,
                    colors.warning,
                    colors.info,
                    colors.success,
                    colors.secondary
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
});
</script>
{% endblock %}