{% extends "base.html" %}

{% block title %}Monthly CVE Summary{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
    /* General Enhancements */
    body {
        background-color: var(--bg-color); /* Use CSS variable instead of hardcoded color */
    }
    .card {
        border: none; /* Remove default card borders */
        border-radius: 0.5rem; /* Softer corners */
        margin-bottom: 1.5rem; /* Consistent spacing */
        box-shadow: var(--card-shadow); /* Use CSS variable instead of hardcoded shadow */
        background-color: var(--card-bg); /* Card background from CSS variable */
    }
    .card-header {
        background-color: var(--card-bg); /* Use CSS variable instead of hardcoded color */
        border-bottom: 1px solid var(--border-color); /* Use CSS variable for border */
        font-weight: 600;
        color: var(--text-color); /* Use CSS variable for text color */
    }
    .breadcrumb-item a {
        text-decoration: none;
        color: var(--primary-color); /* Link color from CSS variable */
    }
    .page-title {
        color: var(--text-color); /* Use CSS variable for text color */
    }

    /* Chart Containers - no change needed */
    .chart-container {
        position: relative;
        height: 350px; /* Slightly taller charts */
        width: 100%;
    }

    /* Table Styling */
    .table th {
        font-weight: 600;
        color: var(--text-color); /* Use CSS variable for text color */
        white-space: nowrap;
        background-color: var(--hover-bg); /* Use CSS variable for background */
    }
    .table td {
        vertical-align: middle;
        color: var(--text-color); /* Use CSS variable for text color */
        border-color: var(--border-color); /* Use CSS variable for border color */
    }
    .month-row {
        transition: background-color 0.2s ease-in-out;
    }
    .month-row:hover {
        background-color: var(--hover-bg); /* Use CSS variable instead of hardcoded color */
    }
    .month-badge {
        width: 40px;
        height: 40px;
        display: inline-flex; /* Use inline-flex */
        align-items: center;
        justify-content: center;
        font-weight: bold;
        border-radius: 50%;
        color: white;
        background-color: var(--primary-color); /* Use CSS variable for background */
        font-size: 1rem;
        margin-right: 0.75rem;
    }
    .month-name {
        font-weight: 500;
        color: var(--text-color); /* Use CSS variable for text color */
    }

    /* Trend Indicators - adapt for dark mode */
    .trend-indicator {
        display: inline-flex;
        align-items: center;
        font-size: 0.85em;
        padding: 0.2em 0.5em;
        border-radius: 0.25rem;
        white-space: nowrap;
    }
    .trend-indicator i {
        margin-right: 0.3em;
    }
    .trend-up {
        color: #ff4d4d; /* More visible in both light and dark modes */
        background-color: rgba(220, 53, 69, 0.15); /* Slightly more opaque */
    }
    .trend-down {
        color: #2bb14c; /* More visible in both light and dark modes */
        background-color: rgba(25, 135, 84, 0.15); /* Slightly more opaque */
    }
    .trend-neutral {
        color: var(--text-muted); /* Use CSS variable for text color */
        background-color: rgba(108, 117, 125, 0.15); /* Slightly more opaque */
    }

    /* Severity Badges & Key Findings */
    /* These remain mostly the same since they're colorful indicators */
    .severity-badge-lg {
        display: inline-block;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        margin-right: 8px;
        vertical-align: middle;
    }
    .severity-critical { background-color: #dc3545; }
    .severity-high { background-color: #fd7e14; }
    .severity-medium { background-color: #ffc107; }
    .severity-low { background-color: #0dcaf0; }
    .severity-unknown { background-color: #6c757d; }

    .key-findings-list .list-group-item {
        border: none; /* Cleaner list */
        padding: 0.75rem 0; /* Adjust padding */
        background-color: transparent; /* Transparent background */
        color: var(--text-color); /* Use CSS variable for text color */
    }
    .key-findings-list .badge {
        font-size: 0.9em;
    }

    /* Year Selector */
    #yearSelector {
        max-width: 150px; /* Limit width */
        background-color: var(--input-bg); /* Use CSS variable */
        color: var(--text-color); /* Use CSS variable */
        border-color: var(--input-border); /* Use CSS variable */
    }
    
    /* Dark mode adjustments for badge styles */
    [data-bs-theme="dark"] .badge.bg-light {
        background-color: #2b3035 !important;
        border-color: #6ea8fe !important;
    }
    
    [data-bs-theme="dark"] .badge.text-dark {
        color: #e9ecef !important;
    }
    
    /* Ensure peak month badge is visible in dark mode */
    [data-bs-theme="dark"] .badge.bg-light.text-dark {
        background-color: #2b3035 !important;
        color: #e9ecef !important; 
    }
    
    /* Alert styling for dark mode */
    [data-bs-theme="dark"] .alert-primary {
        background-color: rgba(13, 110, 253, 0.15);
        color: #e9ecef;
        border-color: rgba(13, 110, 253, 0.4);
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .chart-container {
            height: 300px;
        }
        .page-title {
            font-size: 1.5rem;
        }
        .key-findings-col {
            margin-top: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
            <li class="breadcrumb-item active" aria-current="page">Monthly Summary</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <h1 class="h2 page-title mb-2 mb-md-0"><i class="bi bi-calendar-month text-primary me-2"></i>Monthly CVE Summary</h1>
        <div class="d-flex align-items-center">
            <label for="yearSelector" class="form-label me-2 mb-0 fw-normal text-muted small">Year:</label>
            <select id="yearSelector" class="form-select form-select-sm" aria-label="Year selection">
                {% for year in years %}
                <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Year Header -->
    <div class="alert alert-primary d-flex align-items-center" role="alert">
        <i class="bi bi-info-circle-fill me-2"></i>
        <div>
            Showing data for year: <strong id="displayYear">{{ selected_year }}</strong>
        </div>
    </div>

    <!-- Row for Charts -->
    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-bar-chart-line me-1"></i>Monthly CVE Publication Trend</span>
                    <span id="trendChartYearBadge" class="badge bg-light text-primary border border-primary">{{ selected_year }}</span>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="monthlyTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                   <span><i class="bi bi-pie-chart me-1"></i>Severity Distribution</span>
                   <span id="severityChartYearBadge" class="badge bg-light text-primary border border-primary">{{ selected_year }}</span>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <div class="chart-container" style="height: 300px;"> {# Adjusted height for pie chart space #}
                        <canvas id="severityPieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Row for Table and Key Findings -->
    <div class="row">
        <div class="col-lg-8 mb-4">
            <!-- Monthly Data Table -->
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-table me-1"></i>Monthly Breakdown</span>
                    <span id="tableYearBadge" class="badge bg-light text-primary border border-primary">{{ selected_year }}</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col" class="ps-3">Month</th>
                                    <th scope="col" class="text-center">Total</th>
                                    <th scope="col" class="text-center text-danger">Critical</th>
                                    <th scope="col" class="text-center text-warning">High</th>
                                    <th scope="col" class="text-center text-info">Medium</th>
                                    <th scope="col" class="text-center text-primary">Low</th>
                                    <th scope="col" class="text-center text-secondary">Unknown</th>
                                    <th scope="col" class="pe-3">Trend (vs Prev. Month)</th>
                                </tr>
                            </thead>
                            <tbody id="monthlyDataBody">
                                {# Table rows will be generated by JavaScript #}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4 mb-4 key-findings-col">
             <!-- Key Findings -->
            <div class="card h-100">
                <div class="card-header">
                    <i class="bi bi-search me-1"></i>Key Findings for <span id="keyFindingsYearHeader">{{ selected_year }}</span>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush key-findings-list" id="keyFindingsList">
                        {# List items will be generated by JavaScript #}
                    </ul>
                </div>
            </div>
        </div>
    </div>


    <!-- Yearly Comparison -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="bi bi-graph-up me-1"></i>Year-over-Year Comparison (Last 5 Years)
        </div>
        <div class="card-body">
            <div class="chart-container" style="height: 300px;">
                <canvas id="yearComparisonChart"></canvas>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Data Passed from Flask ---
    const allMonthlyData = {{ summary_data|tojson }};
    const allYears = {{ years|tojson }};
    const initialYear = {{ selected_year|tojson }};
    const monthNames = {{ month_names|tojson }}; // Should be full month names ['January', 'February', ...]
    const htmlElement = document.documentElement;
    const isDarkMode = htmlElement.getAttribute('data-bs-theme') === 'dark';

    // --- Chart Colors (adaptive for dark/light mode) ---
    const colors = {
        primary: '#0d6efd',
        primaryLight: isDarkMode ? 'rgba(13, 110, 253, 0.4)' : 'rgba(13, 110, 253, 0.2)',
        critical: '#dc3545',
        criticalLight: isDarkMode ? 'rgba(220, 53, 69, 0.4)' : 'rgba(220, 53, 69, 0.2)',
        high: '#fd7e14', // Orange for High
        highLight: isDarkMode ? 'rgba(253, 126, 20, 0.4)' : 'rgba(253, 126, 20, 0.2)',
        medium: '#ffc107', // Yellow for Medium
        mediumLight: isDarkMode ? 'rgba(255, 193, 7, 0.4)' : 'rgba(255, 193, 7, 0.2)',
        low: '#0dcaf0', // Cyan for Low
        lowLight: isDarkMode ? 'rgba(13, 202, 240, 0.4)' : 'rgba(13, 202, 240, 0.2)',
        unknown: '#6c757d', // Grey for Unknown
        unknownLight: isDarkMode ? 'rgba(108, 117, 125, 0.4)' : 'rgba(108, 117, 125, 0.2)',
        success: '#198754',
        danger: '#dc3545',
        secondary: '#6c757d',
        chartGrid: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)',
        chartText: isDarkMode ? '#e9ecef' : '#495057',
        pieBorder: isDarkMode ? '#2b3035' : '#ffffff'
    };

    // --- Chart Instances ---
    let trendChart, pieChart, comparisonChart;

    // --- DOM Elements ---
    const yearSelector = document.getElementById('yearSelector');
    const monthlyDataBody = document.getElementById('monthlyDataBody');
    const keyFindingsList = document.getElementById('keyFindingsList');
    const trendChartYearBadge = document.getElementById('trendChartYearBadge');
    const tableYearBadge = document.getElementById('tableYearBadge');
    const severityChartYearBadge = document.getElementById('severityChartYearBadge');
    const keyFindingsYearHeader = document.getElementById('keyFindingsYearHeader');
    const displayYear = document.getElementById('displayYear'); // For the alert box

    // --- Helper Functions ---
    function getMonthDataForYear(year) {
        const data = allMonthlyData[year] || {};
        // Ensure all 12 months are represented, even if empty
        return Array.from({ length: 12 }, (_, i) => {
            const monthNum = i + 1;
            return data[monthNum] || { count: 0, critical: 0, high: 0, medium: 0, low: 0, unknown: 0 };
        });
    }

    function calculateSeverityTotals(yearData) {
        return yearData.reduce((totals, monthData) => {
            totals.critical += monthData.critical || 0;
            totals.high += monthData.high || 0;
            totals.medium += monthData.medium || 0;
            totals.low += monthData.low || 0;
            totals.unknown += monthData.unknown || 0;
            totals.total += monthData.count || 0; // Keep track of total count
            return totals;
        }, { critical: 0, high: 0, medium: 0, low: 0, unknown: 0, total: 0 });
    }

    function getTrendIndicator(currentCount, prevCount) {
        if (prevCount === null || prevCount === undefined || prevCount < 0) { // Handle null/undefined/negative prevCount
             return `<span class="trend-indicator trend-neutral"><i class="bi bi-dash-lg"></i> N/A</span>`;
        }
        const change = currentCount - prevCount;
        if (change > 0) {
            const percentage = prevCount > 0 ? Math.round((change / prevCount) * 100) : 100; // Avoid division by zero
            return `<span class="trend-indicator trend-up"><i class="bi bi-arrow-up-short"></i> +${change} (${percentage}%)</span>`;
        } else if (change < 0) {
             const percentage = prevCount > 0 ? Math.round((Math.abs(change) / prevCount) * 100) : 100; // Avoid division by zero
             return `<span class="trend-indicator trend-down"><i class="bi bi-arrow-down-short"></i> ${change} (${percentage}%)</span>`;
        } else { // change === 0
            return `<span class="trend-indicator trend-neutral"><i class="bi bi-dash-lg"></i> No change</span>`;
        }
    }

    // --- Update Functions ---
    function updateTable(year) {
        monthlyDataBody.innerHTML = ''; // Clear existing rows
        const yearData = getMonthDataForYear(year);
        const prevYear = year - 1;
        const prevYearData = allMonthlyData[prevYear] ? getMonthDataForYear(prevYear) : null;

        // Display months from earliest (January) to latest (December)
        for (let i = 0; i <= 11; i++) { // Loop Jan to Dec
            const monthNum = i + 1;
            const monthData = yearData[i];
            const currentCount = monthData.count || 0;

            // Get previous month's count (handle year boundary)
            let prevCount = null;
            if (i > 0) { // Not January: use previous month of current year
                prevCount = yearData[i - 1].count;
            } else if (prevYearData) { // January: use December of previous year if available
                prevCount = prevYearData[11].count; // December is index 11
            }
            // Ensure prevCount is a number or null
            prevCount = (typeof prevCount === 'number' && !isNaN(prevCount)) ? prevCount : null;


            const trendHtml = getTrendIndicator(currentCount, prevCount);
            const monthAbbr = monthNames[i].substring(0, 3); // Abbreviated month name

            const row = `
                <tr class="month-row" data-month="${monthNum}">
                    <td class="ps-3">
                        <div class="d-flex align-items-center">
                            <div class="month-badge">${monthAbbr}</div>
                            <span class="month-name">${monthNames[i]}</span>
                        </div>
                    </td>
                    <td class="text-center fw-bold">${currentCount}</td>
                    <td class="text-center"><span class="badge bg-danger-light text-danger rounded-pill">${monthData.critical || 0}</span></td>
                    <td class="text-center"><span class="badge bg-warning-light text-warning rounded-pill">${monthData.high || 0}</span></td>
                    <td class="text-center"><span class="badge bg-info-light text-info rounded-pill">${monthData.medium || 0}</span></td>
                    <td class="text-center"><span class="badge bg-primary-light text-primary rounded-pill">${monthData.low || 0}</span></td>
                    <td class="text-center"><span class="badge bg-secondary-light text-secondary rounded-pill">${monthData.unknown || 0}</span></td>
                    <td class="pe-3 text-end">${trendHtml}</td>
                </tr>
            `;
            monthlyDataBody.insertAdjacentHTML('beforeend', row); // Insert at the end for chronological order
        }
        // Update badges
        if(tableYearBadge) tableYearBadge.textContent = year;
        if(displayYear) displayYear.textContent = year; // Update alert box year
    }

    function updateTrendChart(year) {
        if (!trendChart) return; // Don't update if chart not initialized
        const yearData = getMonthDataForYear(year);
        const totalCounts = yearData.map(m => m.count || 0);
        const criticalCounts = yearData.map(m => m.critical || 0);

        trendChart.data.datasets[0].data = totalCounts; // Total CVEs
        trendChart.data.datasets[1].data = criticalCounts; // Critical CVEs
        trendChart.options.plugins.title.text = `Monthly CVE Publications for ${year}`;
        trendChart.update();
        if(trendChartYearBadge) trendChartYearBadge.textContent = year;
    }

    function updateSeverityPieChart(year) {
        if (!pieChart) return; // Don't update if chart not initialized
        const yearData = getMonthDataForYear(year);
        const totals = calculateSeverityTotals(yearData);

        pieChart.data.datasets[0].data = [
            totals.critical,
            totals.high,
            totals.medium,
            totals.low,
            totals.unknown
        ];
        // Ensure labels match data order
        pieChart.data.labels = ['Critical', 'High', 'Medium', 'Low', 'Unknown'];
        pieChart.options.plugins.title.text = `Severity Distribution for ${year}`;
        pieChart.update();
         if(severityChartYearBadge) severityChartYearBadge.textContent = year;
    }

     function updateKeyFindings(year) {
        const yearData = getMonthDataForYear(year);
        const totals = calculateSeverityTotals(yearData);
        const totalCVEs = totals.total; // Use calculated total

        // Find peak month
        let peakMonthIndex = -1;
        let maxCount = -1;
        yearData.forEach((monthData, index) => {
            if ((monthData.count || 0) > maxCount) {
                maxCount = monthData.count;
                peakMonthIndex = index;
            }
        });
        const peakMonthName = peakMonthIndex !== -1 ? monthNames[peakMonthIndex] : 'N/A';

        keyFindingsList.innerHTML = `
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span><i class="bi bi-calendar-event me-2"></i>Total CVEs Published</span>
                <span class="badge bg-primary rounded-pill">${totalCVEs}</span>
            </li>
             <li class="list-group-item d-flex justify-content-between align-items-center">
                <span><i class="bi bi-graph-up-arrow me-2"></i>Peak Month</span>
                <span class="badge bg-light text-dark rounded-pill">${peakMonthName} (${maxCount} CVEs)</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span><div class="severity-badge-lg severity-critical"></div> Critical</span>
                <span class="badge bg-danger rounded-pill">${totals.critical}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span><div class="severity-badge-lg severity-high"></div> High</span>
                <span class="badge bg-warning text-dark rounded-pill">${totals.high}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span><div class="severity-badge-lg severity-medium"></div> Medium</span>
                <span class="badge bg-info text-dark rounded-pill">${totals.medium}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span><div class="severity-badge-lg severity-low"></div> Low</span>
                <span class="badge bg-primary-light text-primary rounded-pill">${totals.low}</span>
            </li>
             <li class="list-group-item d-flex justify-content-between align-items-center">
                <span><div class="severity-badge-lg severity-unknown"></div> Unknown</span>
                <span class="badge bg-secondary rounded-pill">${totals.unknown}</span>
            </li>
        `;
        if(keyFindingsYearHeader) keyFindingsYearHeader.textContent = year;
    }


    // --- Chart Initialization ---
    function initTrendChart() {
        const trendCtx = document.getElementById('monthlyTrendChart')?.getContext('2d');
        if (!trendCtx) return; // Exit if canvas not found
        const initialYearData = getMonthDataForYear(initialYear);
        trendChart = new Chart(trendCtx, {
            type: 'bar',
            data: {
                labels: monthNames.map(m => m.substring(0, 3)), // Use short month names
                datasets: [{
                    label: 'Total CVEs',
                    data: initialYearData.map(m => m.count || 0),
                    backgroundColor: colors.primaryLight,
                    borderColor: colors.primary,
                    borderWidth: 1,
                    order: 2 // Render behind critical
                }, {
                    label: 'Critical CVEs',
                    data: initialYearData.map(m => m.critical || 0),
                    backgroundColor: colors.critical, // Solid color for critical
                    borderColor: colors.critical,
                    borderWidth: 1,
                    type: 'line', // Overlay as a line
                    tension: 0.3,
                    order: 1 // Render on top
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { 
                            display: true, 
                            text: 'Number of CVEs',
                            color: colors.chartText 
                        },
                        grid: {
                            color: colors.chartGrid
                        },
                        ticks: {
                            color: colors.chartText
                        }
                    },
                    x: {
                        title: { 
                            display: true, 
                            text: 'Month',
                            color: colors.chartText 
                        },
                        grid: {
                            color: colors.chartGrid
                        },
                        ticks: {
                            color: colors.chartText
                        }
                    }
                },
                plugins: {
                    title: { display: false }, // Title handled by card header
                    legend: { 
                        display: true, 
                        position: 'top',
                        labels: {
                            color: colors.chartText
                        }
                    },
                    tooltip: { 
                        mode: 'index', 
                        intersect: false,
                        backgroundColor: isDarkMode ? 'rgba(0, 0, 0, 0.7)' : 'rgba(255, 255, 255, 0.9)',
                        titleColor: isDarkMode ? '#ffffff' : '#000000',
                        bodyColor: isDarkMode ? '#e9ecef' : '#495057',
                        borderColor: colors.chartGrid,
                        borderWidth: 1
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
            }
        });
    }

    function initSeverityPieChart() {
        const pieCtx = document.getElementById('severityPieChart')?.getContext('2d');
         if (!pieCtx) return; // Exit if canvas not found
        const initialYearData = getMonthDataForYear(initialYear);
        const initialTotals = calculateSeverityTotals(initialYearData);
        pieChart = new Chart(pieCtx, {
            type: 'doughnut', // Use doughnut for a modern look
            data: {
                labels: ['Critical', 'High', 'Medium', 'Low', 'Unknown'],
                datasets: [{
                    label: 'Severity Distribution',
                    data: [initialTotals.critical, initialTotals.high, initialTotals.medium, initialTotals.low, initialTotals.unknown],
                    backgroundColor: [colors.critical, colors.high, colors.medium, colors.low, colors.unknown],
                    borderColor: colors.pieBorder, // Adaptive border color
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: true, 
                        position: 'bottom', 
                        labels: { 
                            boxWidth: 12,
                            color: colors.chartText
                        } 
                    },
                    title: { display: false }, // Title handled by card header
                    tooltip: {
                        backgroundColor: isDarkMode ? 'rgba(0, 0, 0, 0.7)' : 'rgba(255, 255, 255, 0.9)',
                        titleColor: isDarkMode ? '#ffffff' : '#000000',
                        bodyColor: isDarkMode ? '#e9ecef' : '#495057',
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) + '%' : '0%';
                                    label += context.formattedValue + ` (${percentage})`;
                                }
                                return label;
                            }
                        }
                    }
                },
                cutout: '60%' // Doughnut hole size
            }
        });
    }

    function initYearComparisonChart() {
        const comparisonCtx = document.getElementById('yearComparisonChart')?.getContext('2d');
        if (!comparisonCtx) return; // Exit if canvas not found
        const yearlyDatasets = [];
        // Iterate over available years (reversed to show recent years first, limit to 5)
        const yearsToShow = [...allYears].sort((a, b) => b - a).slice(0, 5); // Sort descending, take top 5

        yearsToShow.forEach((year, index) => {
            const yearData = getMonthDataForYear(year);
            const counts = yearData.map(m => m.count || 0);
            // Generate distinct colors - simple approach
            const hue = (210 + index * 60) % 360; // Cycle through hues

            yearlyDatasets.push({
                label: year.toString(),
                data: counts,
                borderColor: `hsl(${hue}, 70%, 50%)`,
                borderWidth: 2,
                tension: 0.3,
                fill: false,
                pointRadius: 2, // Smaller points
                pointHoverRadius: 4
            });
        });

        comparisonChart = new Chart(comparisonCtx, {
            type: 'line',
            data: {
                labels: monthNames.map(m => m.substring(0, 3)), // Use short month names
                datasets: yearlyDatasets.reverse() // Show oldest year first in legend/tooltip
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { 
                            display: true, 
                            text: 'Total CVEs per Month',
                            color: colors.chartText 
                        },
                        grid: {
                            color: colors.chartGrid
                        },
                        ticks: {
                            color: colors.chartText
                        }
                    },
                    x: {
                        title: { 
                            display: true, 
                            text: 'Month',
                            color: colors.chartText 
                        },
                        grid: {
                            color: colors.chartGrid
                        },
                        ticks: {
                            color: colors.chartText
                        }
                    }
                },
                plugins: {
                    title: { display: false }, // Title handled by card header
                    legend: { 
                        display: true, 
                        position: 'top',
                        labels: {
                            color: colors.chartText
                        }
                    },
                    tooltip: { 
                        mode: 'index', 
                        intersect: false,
                        backgroundColor: isDarkMode ? 'rgba(0, 0, 0, 0.7)' : 'rgba(255, 255, 255, 0.9)',
                        titleColor: isDarkMode ? '#ffffff' : '#000000',
                        bodyColor: isDarkMode ? '#e9ecef' : '#495057',
                        borderColor: colors.chartGrid,
                        borderWidth: 1
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
            }
        });
    }

    // --- Event Listeners ---
    if (yearSelector) {
        yearSelector.addEventListener('change', function() {
            const selectedYear = parseInt(this.value, 10);
            if (isNaN(selectedYear)) return; // Basic validation

            // Update all components
            updateTable(selectedYear);
            updateTrendChart(selectedYear);
            updateSeverityPieChart(selectedYear);
            updateKeyFindings(selectedYear);
            // Note: Year comparison chart shows multiple years, doesn't need update on single year change
        });
    }

    // Listen for theme changes and update charts accordingly
    const darkModeSwitch = document.getElementById('darkModeSwitch');
    if (darkModeSwitch) {
        darkModeSwitch.addEventListener('change', function() {
            // Get the new theme state
            const newIsDarkMode = htmlElement.getAttribute('data-bs-theme') === 'dark';
            
            // Update color scheme based on new theme
            colors.primaryLight = newIsDarkMode ? 'rgba(13, 110, 253, 0.4)' : 'rgba(13, 110, 253, 0.2)';
            colors.criticalLight = newIsDarkMode ? 'rgba(220, 53, 69, 0.4)' : 'rgba(220, 53, 69, 0.2)';
            colors.highLight = newIsDarkMode ? 'rgba(253, 126, 20, 0.4)' : 'rgba(253, 126, 20, 0.2)';
            colors.mediumLight = newIsDarkMode ? 'rgba(255, 193, 7, 0.4)' : 'rgba(255, 193, 7, 0.2)';
            colors.lowLight = newIsDarkMode ? 'rgba(13, 202, 240, 0.4)' : 'rgba(13, 202, 240, 0.2)';
            colors.unknownLight = newIsDarkMode ? 'rgba(108, 117, 125, 0.4)' : 'rgba(108, 117, 125, 0.2)';
            colors.chartGrid = newIsDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';
            colors.chartText = newIsDarkMode ? '#e9ecef' : '#495057';
            colors.pieBorder = newIsDarkMode ? '#2b3035' : '#ffffff';
            
            // Update chart colors
            if (trendChart) {
                // Update scales
                Object.values(trendChart.options.scales).forEach(scale => {
                    if (scale.title) scale.title.color = colors.chartText;
                    scale.ticks.color = colors.chartText;
                    scale.grid.color = colors.chartGrid;
                });
                // Update legend
                trendChart.options.plugins.legend.labels.color = colors.chartText;
                // Update tooltip
                trendChart.options.plugins.tooltip.backgroundColor = newIsDarkMode ? 'rgba(0, 0, 0, 0.7)' : 'rgba(255, 255, 255, 0.9)';
                trendChart.options.plugins.tooltip.titleColor = newIsDarkMode ? '#ffffff' : '#000000';
                trendChart.options.plugins.tooltip.bodyColor = newIsDarkMode ? '#e9ecef' : '#495057';
                // Update datasets
                trendChart.data.datasets[0].backgroundColor = colors.primaryLight;
                trendChart.update();
            }
            
            if (pieChart) {
                // Update legend
                pieChart.options.plugins.legend.labels.color = colors.chartText;
                // Update tooltip
                pieChart.options.plugins.tooltip.backgroundColor = newIsDarkMode ? 'rgba(0, 0, 0, 0.7)' : 'rgba(255, 255, 255, 0.9)';
                pieChart.options.plugins.tooltip.titleColor = newIsDarkMode ? '#ffffff' : '#000000';
                pieChart.options.plugins.tooltip.bodyColor = newIsDarkMode ? '#e9ecef' : '#495057';
                // Update border color
                pieChart.data.datasets[0].borderColor = colors.pieBorder;
                pieChart.update();
            }
            
            if (comparisonChart) {
                // Update scales
                Object.values(comparisonChart.options.scales).forEach(scale => {
                    if (scale.title) scale.title.color = colors.chartText;
                    scale.ticks.color = colors.chartText;
                    scale.grid.color = colors.chartGrid;
                });
                // Update legend
                comparisonChart.options.plugins.legend.labels.color = colors.chartText;
                // Update tooltip
                comparisonChart.options.plugins.tooltip.backgroundColor = newIsDarkMode ? 'rgba(0, 0, 0, 0.7)' : 'rgba(255, 255, 255, 0.9)';
                comparisonChart.options.plugins.tooltip.titleColor = newIsDarkMode ? '#ffffff' : '#000000';
                comparisonChart.options.plugins.tooltip.bodyColor = newIsDarkMode ? '#e9ecef' : '#495057';
                comparisonChart.update();
            }
            
            // Update badge background colors with new theme colors
            const styleSheet = document.createElement("style");
            styleSheet.innerText = `
                .bg-danger-light { background-color: ${colors.criticalLight} !important; }
                .bg-warning-light { background-color: ${colors.highLight} !important; }
                .bg-info-light { background-color: ${colors.mediumLight} !important; }
                .bg-primary-light { background-color: ${colors.lowLight} !important; }
                .bg-secondary-light { background-color: ${colors.unknownLight} !important; }
            `;
            document.head.appendChild(styleSheet);
        });
    }

    // --- Initial Load ---
    updateTable(initialYear);
    initTrendChart();
    initSeverityPieChart();
    updateKeyFindings(initialYear);
    initYearComparisonChart();

    // Add light background colors for badges based on severity
    const styleSheet = document.createElement("style");
    styleSheet.innerText = `
        .bg-danger-light { background-color: ${colors.criticalLight} !important; }
        .bg-warning-light { background-color: ${colors.highLight} !important; }
        .bg-info-light { background-color: ${colors.mediumLight} !important; }
        .bg-primary-light { background-color: ${colors.lowLight} !important; }
        .bg-secondary-light { background-color: ${colors.unknownLight} !important; }
        .text-danger { color: ${colors.critical} !important; }
        .text-warning { color: ${colors.high} !important; }
        .text-info { color: ${colors.medium} !important; }
        .text-primary { color: ${colors.low} !important; } /* Using primary for low text color */
        .text-secondary { color: ${colors.unknown} !important; }
    `;
    document.head.appendChild(styleSheet);

});
</script>
{% endblock %}