{% extends "layout.html" %}

{% block title %}Vulnerability Category: {{ category_name }}{% endblock %}

{% block extra_head %}
<style>
    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 2rem;
    }
    
    .category-card {
        transition: transform 0.2s;
        border-left: 4px solid #0d6efd;
    }
    
    .category-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .severity-badge {
        font-weight: normal;
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
        margin-left: 0.5rem;
    }
    
    .timeline-item {
        border-left: 2px solid #dee2e6;
        padding-left: 20px;
        position: relative;
        padding-bottom: 20px;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -8px;
        top: 0;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background-color: #0d6efd;
    }
    
    .timeline-item:last-child {
        border-left: none;
    }
    
    .cve-count-badge {
        display: inline-block;
        min-width: 40px;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <nav aria-label="breadcrumb" class="mt-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
            <li class="breadcrumb-item active">{{ category_name }}</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{{ category_name }}</h1>
        <div class="input-group" style="max-width: 300px;">
            <input type="text" id="cveSearch" class="form-control" placeholder="Search in results...">
            <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                <i class="bi bi-x"></i>
            </button>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="card category-card h-100">
                <div class="card-body">
                    <h5 class="card-title">Overview</h5>
                    <p class="card-text">{{ category_description }}</p>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <div>Total CVEs:</div>
                        <div><strong>{{ total_cves }}</strong></div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <div>Critical:</div>
                        <div><strong>{{ severity_counts.CRITICAL }}</strong> ({{ severity_percents.CRITICAL }}%)</div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <div>High:</div>
                        <div><strong>{{ severity_counts.HIGH }}</strong> ({{ severity_percents.HIGH }}%)</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-8 mb-3">
            <div class="card category-card h-100">
                <div class="card-body">
                    <h5 class="card-title">Severity Distribution</h5>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="severityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Yearly Trend -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h2 class="h5 mb-0">{{ category_name }} CVEs by Year</h2>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="yearlyTrendChart"></canvas>
            </div>
        </div>
    </div>

    <!-- CVE Listing -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h2 class="h5 mb-0">CVEs in this Category</h2>
            <span id="cveCount" class="badge bg-secondary">{{ total_cves }} vulnerabilities</span>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="cveTable">
                    <thead class="table-light">
                        <tr>
                            <th>CVE ID</th>
                            <th>Severity</th>
                            <th>Description</th>
                            <th>Published</th>
                            <th>CVSS Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if cves %}
                            {% for cve in cves %}
                            <tr>
                                <td><a href="{{ url_for('cve_details', cve_id=cve.cve_id) }}">{{ cve.cve_id }}</a></td>
                                <td>
                                    {% if cve.severity == 'CRITICAL' %}
                                    <span class="badge rounded-pill badge-critical">Critical</span>
                                    {% elif cve.severity == 'HIGH' %}
                                    <span class="badge rounded-pill badge-high">High</span>
                                    {% elif cve.severity == 'MEDIUM' %}
                                    <span class="badge rounded-pill badge-medium">Medium</span>
                                    {% elif cve.severity == 'LOW' %}
                                    <span class="badge rounded-pill badge-low">Low</span>
                                    {% else %}
                                    <span class="badge rounded-pill badge-unknown">Unknown</span>
                                    {% endif %}
                                </td>
                                <td>{{ cve.description[:150] }}{% if cve.description|length > 150 %}...{% endif %}</td>
                                <td>{{ cve.published_date.strftime('%Y-%m-%d') if cve.published_date else 'Unknown' }}</td>
                                <td>
                                    {% if cve.cvss_v3_score %}
                                    <span class="badge rounded-pill bg-dark">V3: {{ cve.cvss_v3_score }}</span>
                                    {% elif cve.cvss_v2_score %}
                                    <span class="badge rounded-pill bg-secondary">V2: {{ cve.cvss_v2_score }}</span>
                                    {% else %}
                                    <span class="badge rounded-pill bg-light">N/A</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="5" class="text-center">No CVEs found for this category.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            
            <!-- No results message -->
            <div id="noCvesMessage" class="alert alert-info text-center d-none">
                <i class="bi bi-info-circle me-2"></i> No CVEs match your search.
            </div>
            
            {% if total_pages and total_pages > 1 %}
            <!-- Pagination -->
            <div class="d-flex justify-content-between align-items-center mt-4">
                <div class="text-muted">
                    Showing {{ (current_page - 1) * per_page + 1 }} to {{ [current_page * per_page, total_cves]|min }} of {{ total_cves }} entries
                </div>
                <div class="pagination-container">
                    <ul class="pagination">
                        <!-- Previous page -->
                        {% if current_page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('vulnerability_category', category_slug=category_slug, page=current_page-1) }}" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <a class="page-link" href="#" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        {% endif %}
                        
                        <!-- Page numbers -->
                        {% set start_page = [current_page - 2, 1]|max %}
                        {% set end_page = [start_page + 4, total_pages]|min %}
                        {% set start_page = [end_page - 4, 1]|max %}
                        
                        {% for page_num in range(start_page, end_page + 1) %}
                        <li class="page-item {% if page_num == current_page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('vulnerability_category', category_slug=category_slug, page=page_num) }}">
                                {{ page_num }}
                            </a>
                        </li>
                        {% endfor %}
                        
                        <!-- Next page -->
                        {% if current_page < total_pages %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('vulnerability_category', category_slug=category_slug, page=current_page+1) }}" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <a class="page-link" href="#" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Related Categories -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h2 class="h5 mb-0">Related Vulnerability Categories</h2>
        </div>
        <div class="card-body">
            <div class="row">
                {% for related in related_categories %}
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">{{ related.name }}</h5>
                            <p class="card-text small">{{ related.description[:100] }}...</p>
                            <a href="{{ url_for('vulnerability_category', category=related.slug) }}" class="btn btn-sm btn-outline-primary">View Category</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Colors for charts
    const colors = {
        critical: '#dc3545',
        high: '#fd7e14',
        medium: '#ffc107',
        low: '#0dcaf0',
        unknown: '#6c757d',
        primary: 'rgba(13, 110, 253, 0.8)',
        primaryBorder: 'rgba(13, 110, 253, 1)'
    };
    
    // Severity pie chart
    const severityCtx = document.getElementById('severityChart').getContext('2d');
    new Chart(severityCtx, {
        type: 'pie',
        data: {
            labels: ['Critical', 'High', 'Medium', 'Low', 'Unknown'],
            datasets: [{
                data: [
                    {{ severity_counts.CRITICAL }},
                    {{ severity_counts.HIGH }},
                    {{ severity_counts.MEDIUM }},
                    {{ severity_counts.LOW }},
                    {{ severity_counts.UNKNOWN }}
                ],
                backgroundColor: [
                    colors.critical,
                    colors.high,
                    colors.medium,
                    colors.low,
                    colors.unknown
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                },
                title: {
                    display: true,
                    text: '{{ category_name }} CVEs by Severity'
                }
            }
        }
    });
    
    // Yearly trend chart
    const yearlyCtx = document.getElementById('yearlyTrendChart').getContext('2d');
    new Chart(yearlyCtx, {
        type: 'bar',
        data: {
            labels: {{ yearly_labels|tojson }},
            datasets: [{
                label: '{{ category_name }} CVEs',
                data: {{ yearly_counts|tojson }},
                backgroundColor: colors.primary,
                borderColor: colors.primaryBorder,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of CVEs'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Year'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Yearly Trend'
                }
            }
        }
    });
    
    // Search functionality
    const cveSearch = document.getElementById('cveSearch');
    const clearSearch = document.getElementById('clearSearch');
    const cveTable = document.getElementById('cveTable');
    const tableRows = cveTable.querySelectorAll('tbody tr');
    const noCvesMessage = document.getElementById('noCvesMessage');
    const cveCount = document.getElementById('cveCount');
    
    function filterTable() {
        const searchTerm = cveSearch.value.toLowerCase();
        let visibleCount = 0;
        
        tableRows.forEach(row => {
            const text = row.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Update visible count
        cveCount.textContent = `${visibleCount} vulnerabilities`;
        
        // Show/hide no results message
        if (visibleCount === 0) {
            noCvesMessage.classList.remove('d-none');
        } else {
            noCvesMessage.classList.add('d-none');
        }
    }
    
    cveSearch.addEventListener('input', filterTable);
    
    clearSearch.addEventListener('click', function() {
        cveSearch.value = '';
        filterTable();
    });
});
</script>
{% endblock %}
